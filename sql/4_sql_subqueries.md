# Подзапросы  
На сегодняшней лекции мы поговорим о подзапросах, CTE (Common Table Expression) и коррелирующих подзапросах.  

**Подзапрос** - это запрос, вложенный в другой запрос.  
**Внешний запрос** - запрос, внутри которого содержится подзапрос.  

![matryoshkas](images/matryoshkas.png)  

Подзапросы позволяют выполнять более сложные операции, разбивая запросы на более мелкие и логические части. Они особенно полезны, когда требуется получить данные на основе результата другого запроса.

PostgreSQL поддерживает несколько типов подзапросов:  
1. Скалярные подзапросы  
2. Многострочные подзапросы   
3. Табличные подзапросы  
4. Коррелирующие подзапросы  
5. Общие табличные выражения  

## Скалярный подзапрос  
**Скалярный подзапрос** возвращает ровно одну строку и один столбец (одно значение). Такие подзапросы часто используют в тех частях основного запроса где находятся `select`, `where` или `having`.   

**Пример**. Предположим, у вас есть таблица `employees` со столбцами `id`, `name`, `salary`. Вы хотите найти имя сотрудникам с самой высокой зарплатой:  
```sql
select employee_name
from employees
where
    salary = (select max(salary) from employees)
```
В этом примере подзапрос `select max(salary) from employees` возвращает одно значение - максимальную зарплату. Внешний запрос, получив результат подзапроса, извлекает имя сотрудника, чья зарплата соответствует этому максимальному значению.  

## Многострочный подзапрос  
**Многострочный подзапрос** возвращает один столбец, но может содержать несколько строк. Этот тип подзапроса полезен когда требуется сравнить несколько значений одновременно.  

**Пример**. Предположим, что у вас есть таблица `customers` с полями `customer_id`, `customer_name`. Также у вас есть таблица `sales` с полями `sale_id`, `sale_timestamp`, `customer_id`, `product_id`. Вам нужно вывести список всех клиентов, которые совершили покупки в Январе.  
```sql
select *
from customers
where
    customer_id in (
        select distinct customer_id
        from sales
        where
            to_char(sale_timestamp, 'month') = 'january'
    )
```

## Табличные подзапросы  
**Табличный подзапрос** возвращает набор результатов, который может содержать несколько строк и  столбцов. Эти подзапросы часто используются в тех частях основного запроса, где находятся операторы `from` и `join`.  

**Пример**. Вам нужно определить минимальное количество покупок среди всех клиентов.  
```sql
select
    min(purchases_cnt)
from (
    select
        customer_id
        , count(*) as purchases_cnt
    from sales
    group by
        customer_id
)
```  

## Коррелирующие подзапросы  
**Коррелирующий подзапрос** - это подзапрос, который выполняется для каждой отдельной строки внешнего запроса.  

**Пример**. Предположим, у вас есть таблица `employees` с колонками `id`, `name`, `department_id` и `salary`. Вы хотите найти сотрудников, чья зарплата выше средней зарплаты в их отделе.
```sql
select name, department_id, salary
from employees e1
where salary > (
    select avg(salary)
    from employees e2
    where e1.department_id = e2.department_id
);
```

## Общие табличные выражения  
**CTE (Common Table Expression)** - это временный результирующий набор данных, к которому можно обращаться из других запросов.  

Синтаксис при использовании CTE выглядит следующим образом:  
```sql
with
<cte_name> as (
    select *
    from <table>
) 
select *
from <cte_name>
```  

